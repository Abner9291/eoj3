<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

	<title>简介 - EOJ Docs</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">EOJ Docs</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">简介</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Web 端 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li >
    <a href="../eoj/polygon/">Polygon</a>
</li>

                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">判题服务器 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        
<li class="active">
    <a href="./">简介</a>
</li>

                    
                        
<li >
    <a href="api/">API</a>
</li>

                    
                        
<li >
    <a href="config/">配置</a>
</li>

                    
                    </ul>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                <li >
                    <a rel="next" href="../eoj/polygon/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="api/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#ejudge">eJudge</a></li>
        
            <li><a href="#_1">文档局限性</a></li>
        
            <li><a href="#_2">简介</a></li>
        
            <li><a href="#_3">判题服务器设计</a></li>
        
            <li><a href="#_4">支持的语言</a></li>
        
            <li><a href="#_5">安装</a></li>
        
            <li><a href="#_8">致谢</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="ejudge">eJudge</h1>
<h2 id="_1">文档局限性</h2>
<p>这里的文档面向正在开发中的 ejudge v2。v1（目前 master 分支）的文档不再更新。</p>
<h2 id="_2">简介</h2>
<p>eJudge 是 eoj3 捆绑销售的判题服务器。主要职责是提供判题服务（废话）。设计判题服务器的主要意图有二：</p>
<ul>
<li>负载均衡：可以根据比赛需求添加减少判题服务器，在节省资源的同时，保证判题速度。</li>
<li>运行安全：提交的代码是不受信任的。在单独的判题服务器中运行方便意外情况的处理。</li>
</ul>
<p>此外，相比其他 OJ 判题服务器，eJudge 还具有以下特色：</p>
<ul>
<li>使用 Docker 急速部署，方便重启。</li>
<li>判题服务提供了 socket.io 和 RESTful API 两种方式，方便判题进程的即时响应及更新。</li>
<li>支持 generator, validator, stress test 等测试工具的运行，为 Polygon system 提供支持（开发中）。</li>
<li>由于在出题过程中程序运行不受限制，「非常危险」，建议采用出题用服务器与主判题服务器相隔离的办法。运行两个服务器，互不干涉。也不用担心泄露数据。</li>
</ul>
<h2 id="_3">判题服务器设计</h2>
<p>为方便读者理解，这里对每个类的设计初衷进行解释。</p>
<h3 id="case">测试用例 (Case)</h3>
<p>每一个测试用例都有一个<strong>指纹</strong> (fingerprint)，这一指纹在上传测试用例的时候就已经指定。请确保指纹的安全性，指纹不应该是由用户指定的，应避免出现 <code>../../finger</code> 这样的情况。
同时需要注意的是，指定指纹的时候应尽可能避免使用 32 位纯字母指纹，避免冲突（虽然冲突概率非常低）。</p>
<p>测试用例含 input 和 output，分别为输入和输出。如果只有 input，那就不能称为测试用例，即使上传 input 也只会带来异常。
要根据 input 生成 output 需要调用另外的 API。</p>
<h3 id="submission">程序 (Submission)</h3>
<p>所有在判题服务器上运行的程序的基类。Submission 本身提供了运行（run）方法，默认开启沙盒运行。</p>
<p>所有程序都有一个<strong>指纹</strong> (fingerprint)，如何获得指纹判题服务器不关心，但应确保唯一。受信任程序是可以永久保存的，
对于受信任程序而言，指纹尤其重要，因为每一个判题请求都需要指定对应的输出检查器，这种指定就是通过指纹来实现的。</p>
<h3 id="specialprogram">受信任程序 (SpecialProgram)</h3>
<p>下称<strong>测试程序</strong>。测试程序并不是一定用于判题的，也可能用于生成数据等等。此类程序的共同特点是可能有文件操作，所以沙盒限制较为宽松。
由用户提交的受信任程序需在 Polygon 中运行，用户需同意不破坏原则。</p>
<h4 id="checker">输出检查 (Checker)</h4>
<p>提供对输出进行检查的程序。</p>
<h4 id="validator">输入检查 (Validator)</h4>
<p>提供对输入进行检查的程序。</p>
<h4 id="generator">生成器 (Generator)</h4>
<p>用于生成输入数据。</p>
<h4 id="interactor">交互 (Interactor)</h4>
<p>用于交互题。</p>
<p>详细用法参见 EOJ Polygon 的介绍。</p>
<h3 id="caserunner">运行 (CaseRunner)</h3>
<p>一个组合了测试用例、提交程序、测试程序的类，提供方便的运行功能，并且可以指定输出的结果（返回什么）。</p>
<h3 id="verdict">判定结果 (Verdict)</h3>
<ul>
<li>WAITING = -3</li>
<li>JUDGING = -2</li>
<li>WRONG_ANSWER = -1</li>
<li>ACCEPTED = 0</li>
<li>TIME_LIMIT_EXCEEDED = 1</li>
<li>IDLENESS_LIMIT_EXCEEDED = 2</li>
<li>MEMORY_LIMIT_EXCEEDED = 3</li>
<li>RUNTIME_ERROR = 4</li>
<li>SYSTEM_ERROR = 5</li>
<li>COMPILE_ERROR = 6</li>
<li>JUDGE_ERROR = 11</li>
</ul>
<h2 id="_4">支持的语言</h2>
<p>括号内是在 <code>lang</code> 字段中填写的。</p>
<ul>
<li>C (c)</li>
<li>C++ 11 (cpp)</li>
<li>C++ 14 (cc14)</li>
<li>C# (cs)</li>
<li>Pascal (pas)</li>
<li>Java (java)</li>
<li>Python 2 (py2)</li>
<li>Python 3 (python)</li>
<li>Pypy (pypy)</li>
<li>Perl (perl)</li>
<li>OCaml (ocaml)</li>
<li>PHP (php)</li>
<li>Rust (rs)</li>
<li>Haskell (hs)</li>
<li>Javascript (js)</li>
</ul>
<p>（部分语言命名诡异是为了确保向下兼容性。）</p>
<h2 id="_5">安装</h2>
<h3 id="_6">部署</h3>
<p>Docker：<code>curl -sSL http://acs-public-mirror.oss-cn-hangzhou.aliyuncs.com/docker-engine/internet | sh -</code></p>
<p>外网：<code>sudo docker pull registry.cn-hangzhou.aliyuncs.com/ultmaster/ejudge:v2</code></p>
<p>阿里云内网：<code>sudo docker pull registry-internal.cn-hangzhou.aliyuncs.com/ultmaster/ejudge:v2</code></p>
<p>运行：<code>sudo docker run -d -p YOUR_RORT:5000 registry-internal.cn-hangzhou.aliyuncs.com/ultmaster/ejudge:v2</code></p>
<p>主目录 ejudge 是通过数据卷的形式挂载在容器内的，所以可以通过 <code>docker inspect -f {{.Mounts}} YOUR_DOCKER_ID</code> 的 mount 下的地址找到。
找到该目录的意义，就在于该目录下的 <code>/run</code> 便是所有数据的存放、程序运行的位置，另外 <code>/run/log</code> 下是程序运行日志。要修改密码，修改配置，也要修改该目录下的 <code>config</code> 子目录。
可以加个软链接来快速访问。如果有更简洁的方法，欢迎补充！</p>
<h3 id="_7">开发</h3>
<ul>
<li>
<p>先创建一个用户：<code>useradd -r compiler</code></p>
</li>
<li>
<p>拷贝 java policy：<code>cp sandbox/java_policy /etc/</code></p>
</li>
<li>
<p>安装依赖包（见 Dockerfile）：<code>pip3 install -r requirements.txt</code>, <code>apt-get -y install gcc g++ ...</code></p>
</li>
<li>
<p>编译 Cython：<code>python3 setup.py build_ext --inplace</code></p>
</li>
<li>
<p>创建目录：<code>mkdir -p run/data run/sub run/log</code></p>
</li>
</ul>
<p>然后就从运行 <code>tests</code> 中的测试开始吧。注意在运行 <code>flask</code> 测试前要先运行 flask 服务器和 celery：</p>
<ul>
<li>
<p>运行 redis：<code>service redis-server start</code></p>
</li>
<li>
<p>运行 celery：</p>
<ul>
<li>阻塞：<code>celery worker -A handler --loglevel=info</code></li>
<li>守护：<code>celery multi start worker -A handler</code></li>
</ul>
</li>
<li>
<p>运行 flask：<code>./flask_server.py</code></p>
</li>
</ul>
<p>在生产环境下的命令见 <code>run.sh</code>。</p>
<h2 id="_8">致谢</h2>
<p>eJudge 由 eoj3 团队开发。</p>
<p>eJudge 的设计借（照）鉴（抄）了 <a href="https://github.com/QingdaoU/Judger/tree/newnew">QDUOJ Judger</a> 中对 seccomp 的使用，
专业出题网站 <a href="https://polygon.codeforces.com/">Codeforces Polygon</a> 中对测试程序的使用，
开源项目 <a href="https://github.com/MikeMirzayanov/testlib">testlib</a>
实现的 C++ 库，<a href="https://github.com/vfleaking/uoj">UOJ</a> 中对 Docker 的使用，
以及 <a href="https://github.com/vijos/jd4">vijos jd4</a> 中的类设计。</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            
            <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
        </footer>

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
        <script>var base_url = '..';</script>
        <script data-main="../mkdocs/js/search.js" src="../mkdocs/js/require.js"></script>
        <script src="../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>